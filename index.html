<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Açaí Rei - Sistema Online</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDK (Versão 9 - Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ==================== CONFIGURAÇÃO FIREBASE ====================
        // SUBSTITUA ESTE OBJETO PELAS SUAS CREDENCIAIS DO FIREBASE!
        const firebaseConfig = {
            apiKey: "AIzaSyDi3S2ujrwKE19a5FGRZafWKIXw-8tbJ9A",
            authDomain: "acairei-b4bca.firebaseapp.com",
            databaseURL: "https://acairei-b4bca-default-rtdb.firebaseio.com",
            projectId: "acairei-b4bca",
            storageBucket: "acairei-b4bca.firebasestorage.app",
            messagingSenderId: "591817620965",
            appId: "1:591817620965:web:f634d2ac90dd033872430c"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Tornar disponível globalmente
        window.firebaseDB = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbPush = push;
        window.dbOnValue = onValue;
        window.dbRemove = remove;
        window.dbUpdate = update;
        window.dbGet = get;
        window.dbChild = child;
    </script>
    
    <style>
        /* [MANTENHA TODO O SEU CSS EXISTENTE AQUI - NÃO ALTEREI PARA ECONOMIZAR ESPAÇO] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a0a2e 0%, #4a148c 50%, #7c43bd 100%);
            min-height: 100vh;
            color: #333;
        }
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.6s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .logo-section { text-align: center; margin-bottom: 2rem; }
        .logo-container { width: 100px; height: 100px; margin: 0 auto 1rem; }
        .logo-image {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 4px solid white; box-shadow: 0 10px 30px rgba(124, 67, 189, 0.4);
        }
        h1 { color: #4a148c; font-size: 1.8rem; margin-bottom: 0.3rem; }
        .subtitle { color: #666; font-size: 0.9rem; }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.4rem; color: #4a148c; font-weight: 600; font-size: 0.85rem; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #7c43bd; }
        input, select {
            width: 100%; padding: 0.9rem 1rem 0.9rem 2.8rem;
            border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1rem;
            transition: all 0.3s; background: #fafafa;
        }
        input:focus, select:focus {
            outline: none; border-color: #7c43bd; background: white;
            box-shadow: 0 0 0 4px rgba(124, 67, 189, 0.1);
        }
        .toggle-password {
            position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: #999;
        }
        .login-btn {
            width: 100%; padding: 1rem;
            background: linear-gradient(135deg, #7c43bd 0%, #4a148c 100%);
            color: white; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s; margin-top: 0.5rem;
        }
        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 10px 25px rgba(124, 67, 189, 0.4);
        }
        .login-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .error-message {
            background: #ffebee; color: #c62828; padding: 0.75rem;
            border-radius: 8px; margin-bottom: 1rem; display: none;
            align-items: center; gap: 0.5rem; font-size: 0.9rem;
        }
        .loading {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,.3); border-radius: 50%;
            border-top-color: white; animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .app-screen { display: none; min-height: 100vh; }
        .app-header {
            background: white; padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 1rem;
        }
        .app-header h2 { color: #4a148c; display: flex; align-items: center; gap: 0.5rem; }
        .sync-status {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.85rem; color: #666;
        }
        .sync-status.synced { color: #4caf50; }
        .sync-status.syncing { color: #ff9800; }
        .sync-status.offline { color: #f44336; }
        .user-info { display: flex; align-items: center; gap: 1rem; color: #666; font-size: 0.9rem; }
        .logout-btn {
            background: #ffebee; color: #c62828; border: none;
            padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;
            font-size: 0.85rem; transition: all 0.3s;
        }
        .logout-btn:hover { background: #ffcdd2; }
        .btn-sync {
            background: #e3f2fd; color: #1565c0; border: none;
            padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;
            font-size: 0.85rem; transition: all 0.3s;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .btn-sync:hover { background: #bbdefb; }
        .tabs-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        .tabs-nav {
            display: flex; gap: 0.5rem; margin-bottom: 2rem;
            background: white; padding: 0.5rem; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow-x: auto;
        }
        .tab-btn {
            flex: 1; padding: 1rem; border: none; background: transparent;
            color: #666; font-weight: 600; cursor: pointer; border-radius: 12px;
            transition: all 0.3s; display: flex; align-items: center;
            justify-content: center; gap: 0.5rem; white-space: nowrap; min-width: 100px;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #7c43bd 0%, #4a148c 100%);
            color: white; box-shadow: 0 4px 15px rgba(124, 67, 189, 0.3);
        }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background: white; border-radius: 20px; padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 2rem;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;
        }
        .card-title { color: #4a148c; font-size: 1.3rem; display: flex; align-items: center; gap: 0.5rem; }
        .caixa-status { text-align: center; padding: 2rem 1rem; }
        .caixa-icon {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; margin: 0 auto 1rem;
            font-size: 2.5rem; color: #c62828; transition: all 0.3s;
        }
        .caixa-icon.aberto {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #4caf50; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .caixa-info {
            margin: 1.5rem 0; padding: 1.5rem; background: #f5f5f5;
            border-radius: 12px; display: none;
        }
        .caixa-info.show { display: block; }
        .caixa-info p { margin: 0.5rem 0; color: #555; font-size: 1rem; }
        .caixa-info strong { color: #4a148c; }
        .btn-caixa {
            padding: 1rem 2rem; font-size: 1rem; border: none;
            border-radius: 12px; cursor: pointer; font-weight: 600;
            transition: all 0.3s; display: inline-flex; align-items: center;
            gap: 0.5rem; margin: 0.5rem;
        }
        .btn-abrir { background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; }
        .btn-fechar { background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: white; }
        .btn-caixa:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .btn-caixa:disabled { opacity: 0.6; cursor: not-allowed; }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; margin-bottom: 1rem;
        }
        .form-group-compact { display: flex; flex-direction: column; }
        .form-group-compact label { font-size: 0.8rem; margin-bottom: 0.3rem; }
        .form-group-compact input, .form-group-compact select {
            padding: 0.8rem; border: 2px solid #e0e0e0;
            border-radius: 10px; font-size: 0.95rem;
        }
        .btn-add {
            background: linear-gradient(135deg, #7c43bd 0%, #4a148c 100%);
            color: white; border: none; padding: 0.8rem 2rem;
            border-radius: 10px; cursor: pointer; font-weight: 600;
            transition: all 0.3s; margin-top: 1.5rem; width: 100%;
        }
        .btn-add:hover:not(:disabled) { transform: scale(1.02); }
        .btn-add:disabled { opacity: 0.6; cursor: not-allowed; }
        .table-container { overflow-x: auto; margin-top: 1.5rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f5f5f5; color: #4a148c; padding: 0.8rem; text-align: left; font-weight: 600; font-size: 0.85rem; }
        td { padding: 0.8rem; border-bottom: 1px solid #eee; color: #555; }
        tr:hover { background: #fafafa; }
        .btn-action { background: none; border: none; padding: 0.4rem; cursor: pointer; border-radius: 6px; transition: all 0.3s; margin: 0 0.2rem; }
        .btn-edit { color: #2196f3; }
        .btn-edit:hover { background: #e3f2fd; }
        .btn-delete { color: #f44336; }
        .btn-delete:hover { background: #ffebee; }
        .tag { display: inline-block; padding: 0.3rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .tag-presencial { background: #e3f2fd; color: #1565c0; }
        .tag-delivery { background: #fff3e0; color: #e65100; }
        .total-section {
            background: linear-gradient(135deg, #4a148c 0%, #7c43bd 100%);
            color: white; padding: 1.5rem; border-radius: 16px;
            margin-top: 1.5rem; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 1rem;
        }
        .total-label { font-size: 1rem; opacity: 0.9; }
        .total-value { font-size: 1.8rem; font-weight: 700; }
        .badge { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-success { background: #e8f5e9; color: #2e7d32; }
        .badge-danger { background: #ffebee; color: #c62828; }
        .faturas-list { display: grid; gap: 1rem; }
        .fatura-card {
            background: #f8f9fa; border-radius: 16px; padding: 1.5rem;
            cursor: pointer; transition: all 0.3s; border: 2px solid transparent;
        }
        .fatura-card:hover { border-color: #7c43bd; transform: translateX(5px); }
        .fatura-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .fatura-numero { color: #4a148c; font-weight: 700; font-size: 1.1rem; }
        .fatura-status { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-aberta { background: #e8f5e9; color: #2e7d32; }
        .status-fechada { background: #e3f2fd; color: #1565c0; }
        .fatura-info { color: #666; font-size: 0.9rem; display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .fatura-total { color: #4a148c; font-weight: 700; font-size: 1.1rem; }
        .dispensas-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .dispensa-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; background: #f5f5f5; border-radius: 12px;
            margin-bottom: 0.8rem; cursor: pointer; transition: all 0.3s;
        }
        .dispensa-item:hover { background: #e8f5e9; transform: translateX(5px); }
        .dispensa-item.selected { background: #e8f5e9; border: 2px solid #4caf50; }
        .dispensa-valor { font-size: 1.2rem; font-weight: 700; color: #4caf50; }
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000; align-items: center; justify-content: center; padding: 1rem;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 24px; padding: 2rem;
            max-width: 700px; width: 100%; max-height: 90vh;
            overflow-y: auto; animation: slideUp 0.3s ease;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;
        }
        .modal-title { color: #4a148c; font-size: 1.3rem; }
        .btn-close { background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; }
        .btn-close:hover { color: #333; }
        .empty-state { text-align: center; color: #999; padding: 3rem; }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }
        @media (max-width: 968px) { .dispensas-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .tabs-nav { flex-direction: column; }
            .app-header { flex-direction: column; text-align: center; }
            table { font-size: 0.8rem; }
            th, td { padding: 0.5rem; }
        }
        .connection-status {
            position: fixed; bottom: 20px; right: 20px;
            padding: 10px 20px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            z-index: 9999; transition: all 0.3s;
        }
        .connection-online { background: #4caf50; color: white; }
        .connection-offline { background: #f44336; color: white; }
    </style>
</head>
<body>

    <!-- INDICADOR DE CONEXÃO -->
    <div id="connectionStatus" class="connection-status connection-online" style="display: none;">
        <i class="fas fa-wifi"></i> <span id="connectionText">Online</span>
    </div>

    <!-- TELA DE LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="logo-section">
                <div class="logo-container">
                    <img src="https://i.ibb.co/sr0dSjh/logo-acai.png" 
                         alt="Logo Açaí Rei" 
                         class="logo-image"
                         onerror="this.src='https://via.placeholder.com/100/4a148c/ffffff?text=Açaí+Rei'">
                </div>
                <h1>Açaí Rei</h1>
                <p class="subtitle">Sistema Online Sincronizado</p>
            </div>

            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText">Usuário ou senha incorretos!</span>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuário</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" id="username" placeholder="Digite seu usuário" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Senha</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" placeholder="Digite sua senha" required>
                        <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                    </div>
                </div>

                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
            </form>
        </div>
    </div>

    <!-- APLICATIVO PRINCIPAL -->
    <div class="app-screen" id="appScreen">
        <header class="app-header">
            <h2><i class="fas fa-crown"></i> Açaí Rei</h2>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="btn-sync" onclick="sincronizarDados()" title="Sincronizar dados manualmente">
                    <i class="fas fa-sync-alt"></i> Sincronizar
                </button>
                <div class="sync-status synced" id="syncStatus">
                    <i class="fas fa-check-circle"></i> <span id="syncText">Sincronizado</span>
                </div>
                <div class="user-info">
                    <span id="currentUser"></span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </header>

        <div class="tabs-container">
            <!-- Navegação -->
            <nav class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab('caixa', this)">
                    <i class="fas fa-cash-register"></i> Caixa
                </button>
                <button class="tab-btn" onclick="switchTab('produtos', this)">
                    <i class="fas fa-ice-cream"></i> Vendas
                </button>
                <button class="tab-btn" onclick="switchTab('dispensas', this)">
                    <i class="fas fa-shopping-cart"></i> Dispensas
                </button>
                <button class="tab-btn" onclick="switchTab('faturas', this)">
                    <i class="fas fa-receipt"></i> Faturas
                </button>
            </nav>

            <!-- ABA 1: CAIXA -->
            <div class="tab-content active" id="tab-caixa">
                <div class="card">
                    <div class="caixa-status">
                        <div class="caixa-icon" id="caixaIcon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h2 id="caixaTitulo">Caixa Fechado</h2>
                        <p style="color: #666; margin: 0.5rem 0 1.5rem;">Clique abaixo para iniciar o expediente</p>
                        
                        <div class="caixa-info" id="caixaInfo">
                            <p><i class="fas fa-play-circle" style="color: #4caf50;"></i> <strong>Aberto em:</strong> <span id="horaAbertura">-</span></p>
                            <p><i class="fas fa-stop-circle" style="color: #f44336;"></i> <strong>Fechado em:</strong> <span id="horaFechamento">-</span></p>
                            <p><i class="fas fa-clock" style="color: #7c43bd;"></i> <strong>Duração:</strong> <span id="duracao">-</span></p>
                        </div>

                        <button class="btn-caixa btn-abrir" id="btnCaixa" onclick="toggleCaixa()">
                            <i class="fas fa-lock-open"></i> Abrir Caixa
                        </button>
                    </div>
                </div>
            </div>

            <!-- ABA 2: PRODUTOS VENDIDOS -->
            <div class="tab-content" id="tab-produtos">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-plus-circle"></i> Registrar Venda</h3>
                        <span id="caixaStatusBadge" class="badge badge-danger">
                            <i class="fas fa-lock"></i> Caixa Fechado
                        </span>
                    </div>

                    <form id="vendaForm" onsubmit="addProduto(event)">
                        <div class="form-grid">
                            <div class="form-group-compact">
                                <label><i class="fas fa-user"></i> Cliente</label>
                                <input type="text" id="nomeCliente" placeholder="Nome do cliente" required>
                            </div>
                            <div class="form-group-compact">
                                <label><i class="fas fa-ice-cream"></i> Produto</label>
                                <input type="text" id="nomeProduto" placeholder="Nome do produto" required>
                            </div>
                            <div class="form-group-compact">
                                <label><i class="fas fa-dollar-sign"></i> Valor (R$)</label>
                                <input type="number" id="valorProduto" placeholder="0,00" step="0.01" min="0" required>
                            </div>
                            <div class="form-group-compact">
                                <label><i class="fas fa-credit-card"></i> Pagamento</label>
                                <select id="formaPagamento" required>
                                    <option value="">Selecione</option>
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Cartão Crédito">Cartão Crédito</option>
                                    <option value="Cartão Débito">Cartão Débito</option>
                                    <option value="PIX">PIX</option>
                                    <option value="PicPay">PicPay</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group-compact">
                                <label><i class="fas fa-motorcycle"></i> Tipo</label>
                                <select id="tipoEntrega" required>
                                    <option value="">Selecione</option>
                                    <option value="Presencial">Presencial</option>
                                    <option value="Delivery">Delivery</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-add" id="btnAddVenda">
                            <i class="fas fa-plus"></i> Adicionar Venda
                        </button>
                    </form>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Produto</th>
                                    <th>Valor</th>
                                    <th>Pagamento</th>
                                    <th>Tipo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaProdutos">
                                <tr>
                                    <td colspan="6" class="empty-state" style="padding: 2rem;">
                                        Nenhuma venda registrada
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="total-section">
                        <span class="total-label">Total de Vendas</span>
                        <span class="total-value" id="totalVendas">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <!-- ABA 3: DISPENSAS -->
            <div class="tab-content" id="tab-dispensas">
                <div class="dispensas-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-plus-circle"></i> Cadastrar Produto</h3>
                        </div>
                        <form id="dispensaForm" onsubmit="addDispensa(event)">
                            <div class="form-group-compact" style="margin-bottom: 1rem;">
                                <label><i class="fas fa-box"></i> Nome do Produto</label>
                                <input type="text" id="nomeDispensa" placeholder="Ex: Copo 500ml" required>
                            </div>
                            <div class="form-group-compact" style="margin-bottom: 1rem;">
                                <label><i class="fas fa-dollar-sign"></i> Valor Unitário (R$)</label>
                                <input type="number" id="valorDispensa" placeholder="0,00" step="0.01" min="0" required>
                            </div>
                            <button type="submit" class="btn-add">
                                <i class="fas fa-save"></i> Cadastrar Produto
                            </button>
                        </form>

                        <div style="margin-top: 2rem;">
                            <h4 style="color: #4a148c; margin-bottom: 1rem;"><i class="fas fa-list"></i> Produtos Cadastrados</h4>
                            <div id="listaDispensasCadastradas">
                                <div class="empty-state" style="padding: 1rem;">
                                    <p>Nenhum produto cadastrado</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-shopping-cart"></i> Registrar Compra</h3>
                        </div>
                        <p style="color: #666; margin-bottom: 1rem;">Clique nos produtos para adicionar à compra:</p>
                        
                        <div id="listaDispensasCompra" style="max-height: 400px; overflow-y: auto;">
                            <div class="empty-state" style="padding: 1rem;">
                                <p>Cadastre produtos primeiro</p>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="color: #666;">Itens: <strong id="countItens">0</strong></span>
                                <span style="color: #4a148c; font-size: 1.3rem; font-weight: 700;" id="totalDispensa">R$ 0,00</span>
                            </div>
                            <button class="btn-add" onclick="finalizarCompraDispensa()" id="btnFinalizarCompra" disabled>
                                <i class="fas fa-check"></i> Finalizar Compra
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-history"></i> Histórico de Compras</h3>
                    </div>
                    <div id="historicoDispensas">
                        <div class="empty-state">
                            <i class="fas fa-shopping-bag"></i>
                            <p>Nenhuma compra registrada</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 4: FATURAS -->
            <div class="tab-content" id="tab-faturas">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-history"></i> Histórico de Faturas</h3>
                    </div>
                    
                    <div class="faturas-list" id="listaFaturas">
                        <div class="empty-state">
                            <i class="fas fa-receipt"></i>
                            <p>Nenhuma fatura registrada</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS -->
    <div class="modal" id="modalEditar" onclick="if(event.target === this) closeModalEditar()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> Editar Venda</h3>
                <button class="btn-close" onclick="closeModalEditar()">&times;</button>
            </div>
            <form id="formEditarVenda" onsubmit="salvarEdicao(event)">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group-compact">
                        <label>Cliente</label>
                        <input type="text" id="editCliente" required>
                    </div>
                    <div class="form-group-compact">
                        <label>Produto</label>
                        <input type="text" id="editProduto" required>
                    </div>
                    <div class="form-group-compact">
                        <label>Valor (R$)</label>
                        <input type="number" id="editValor" step="0.01" min="0" required>
                    </div>
                    <div class="form-group-compact">
                        <label>Pagamento</label>
                        <select id="editPagamento" required>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão Crédito">Cartão Crédito</option>
                            <option value="Cartão Débito">Cartão Débito</option>
                            <option value="PIX">PIX</option>
                            <option value="PicPay">PicPay</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group-compact">
                        <label>Tipo</label>
                        <select id="editTipo" required>
                            <option value="Presencial">Presencial</option>
                            <option value="Delivery">Delivery</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-add" style="margin-top: 1rem;">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </form>
        </div>
    </div>

    <div class="modal" id="modalFatura" onclick="if(event.target === this) closeModalFatura()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-invoice"></i> Detalhes da Fatura</h3>
                <button class="btn-close" onclick="closeModalFatura()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <div class="modal" id="modalCompra" onclick="if(event.target === this) closeModalCompra()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-shopping-bag"></i> Detalhes da Compra</h3>
                <button class="btn-close" onclick="closeModalCompra()">&times;</button>
            </div>
            <div id="modalCompraBody"></div>
        </div>
    </div>

    <script type="module">
        // Aguardar Firebase carregar
        await new Promise(resolve => {
            if (window.firebaseDB) resolve();
            else setTimeout(resolve, 1000);
        });

        const db = window.firebaseDB;
        const { ref, set, push, onValue, remove, update, get, child } = window;

        // ==================== CREDENCIAIS ====================
        const CREDENTIALS = {
            username: 'Açai Rei001',
            password: '170920'
        };

        // ==================== ESTADO ====================
        let caixaAberto = false;
        let horaAbertura = null;
        let produtosVenda = [];
        let faturas = [];
        let faturaAtual = null;
        let currentUser = null;
        let dispensas = [];
        let comprasDispensa = [];
        let itensSelecionados = new Set();
        let isOnline = true;

        // ==================== REFERÊNCIAS DO BANCO ====================
        const dbRefs = {
            caixa: ref(db, 'caixa'),
            vendas: ref(db, 'vendas'),
            faturas: ref(db, 'faturas'),
            dispensas: ref(db, 'dispensas'),
            compras: ref(db, 'compras'),
            conexao: ref(db, '.info/connected')
        };

        // ==================== MONITORAMENTO DE CONEXÃO ====================
        onValue(dbRefs.conexao, (snap) => {
            isOnline = snap.val() === true;
            updateConnectionStatus();
        });

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            if (isOnline) {
                statusEl.className = 'connection-status connection-online';
                statusEl.style.display = 'flex';
                textEl.textContent = 'Online';
                syncStatus.className = 'sync-status synced';
                syncText.textContent = 'Sincronizado';
                setTimeout(() => statusEl.style.display = 'none', 3000);
            } else {
                statusEl.className = 'connection-status connection-offline';
                statusEl.style.display = 'flex';
                textEl.textContent = 'Offline - Modo Local';
                syncStatus.className = 'sync-status offline';
                syncText.textContent = 'Offline';
            }
        }

        // ==================== INICIALIZAÇÃO ====================
        window.addEventListener('load', () => {
            checkAuth();
            setupRealtimeListeners();
        });

        function checkAuth() {
            const savedSession = localStorage.getItem('acaiRei_session');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                currentUser = session.user;
                showApp();
            } else {
                showLogin();
            }
        }

        function setupRealtimeListeners() {
            // Ouvir mudanças no caixa em tempo real
            onValue(dbRefs.caixa, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    caixaAberto = data.aberto || false;
                    horaAbertura = data.horaAbertura ? new Date(data.horaAbertura) : null;
                    faturaAtual = data.faturaAtual || null;
                    updateCaixaUI();
                }
            });

            // Ouvir vendas em tempo real
            onValue(dbRefs.vendas, (snapshot) => {
                const data = snapshot.val();
                produtosVenda = data ? Object.values(data) : [];
                atualizarTabela();
                atualizarTotal();
            });

            // Ouvir faturas em tempo real
            onValue(dbRefs.faturas, (snapshot) => {
                const data = snapshot.val();
                faturas = data ? Object.values(data).reverse() : [];
                carregarFaturas();
            });

            // Ouvir dispensas em tempo real
            onValue(dbRefs.dispensas, (snapshot) => {
                const data = snapshot.val();
                dispensas = data ? Object.values(data) : [];
                carregarDispensas();
            });

            // Ouvir compras em tempo real
            onValue(dbRefs.compras, (snapshot) => {
                const data = snapshot.val();
                comprasDispensa = data ? Object.values(data).reverse() : [];
                carregarHistoricoDispensas();
            });
        }

        // ==================== LOGIN ====================
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div> Entrando...';

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (username === CREDENTIALS.username && password === CREDENTIALS.password) {
                const session = { user: username };
                localStorage.setItem('acaiRei_session', JSON.stringify(session));
                currentUser = username;
                showApp();
            } else {
                showError('Usuário ou senha incorretos!');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar no Sistema';
            }
        });

        function showError(msg) {
            const error = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = msg;
            error.style.display = 'flex';
            setTimeout(() => error.style.display = 'none', 3000);
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser;
        }

        // ==================== FUNÇÕES FIREBASE ====================
        async function salvarCaixa() {
            const dados = {
                aberto: caixaAberto,
                horaAbertura: horaAbertura ? horaAbertura.toISOString() : null,
                faturaAtual: faturaAtual,
                lastUpdate: new Date().toISOString()
            };
            await set(dbRefs.caixa, dados);
        }

        async function adicionarVendaFirebase(venda) {
            const novaVendaRef = push(dbRefs.vendas);
            await set(novaVendaRef, { ...venda, firebaseId: novaVendaRef.key });
            return novaVendaRef.key;
        }

        async function removerVendaFirebase(firebaseId) {
            await remove(child(dbRefs.vendas, firebaseId));
        }

        async function atualizarVendaFirebase(firebaseId, dados) {
            await update(child(dbRefs.vendas, firebaseId), dados);
        }

        async function adicionarFaturaFirebase(fatura) {
            const novaFaturaRef = push(dbRefs.faturas);
            await set(novaFaturaRef, { ...fatura, firebaseId: novaFaturaRef.key });
        }

        async function adicionarDispensaFirebase(dispensa) {
            const novaDispensaRef = push(dbRefs.dispensas);
            await set(novaDispensaRef, { ...dispensa, firebaseId: novaDispensaRef.key });
        }

        async function removerDispensaFirebase(firebaseId) {
            await remove(child(dbRefs.dispensas, firebaseId));
        }

        async function adicionarCompraFirebase(compra) {
            const novaCompraRef = push(dbRefs.compras);
            await set(novaCompraRef, { ...compra, firebaseId: novaCompraRef.key });
        }

        async function limparVendasFirebase() {
            await set(dbRefs.vendas, null);
        }

        // ==================== SINCRONIZAÇÃO MANUAL ====================
        window.sincronizarDados = async function() {
            const status = document.getElementById('syncStatus');
            const text = document.getElementById('syncText');
            
            status.className = 'sync-status syncing';
            text.textContent = 'Sincronizando...';

            try {
                // Forçar sincronização manual (útil quando offline/online)
                await get(ref(db, '.info/connected'));
                
                status.className = 'sync-status synced';
                text.textContent = 'Sincronizado';
                
                // Backup local como fallback
                const dados = {
                    faturas, dispensas, comprasDispensa,
                    lastSync: new Date().toISOString()
                };
                localStorage.setItem('acaiRei_backup', JSON.stringify(dados));
                
            } catch (error) {
                console.error('Erro sincronização:', error);
                status.className = 'sync-status offline';
                text.textContent = 'Erro na sincronização';
            }
        };

        // ==================== CAIXA ====================
        window.toggleCaixa = async function() {
            if (!caixaAberto) {
                await abrirCaixa();
            } else {
                if (confirm('Deseja realmente fechar o caixa?')) {
                    await fecharCaixa();
                }
            }
        };

        async function abrirCaixa() {
            caixaAberto = true;
            horaAbertura = new Date();
            
            faturaAtual = {
                id: Date.now(),
                dataAbertura: horaAbertura.toISOString(),
                dataFechamento: null,
                produtos: [],
                total: 0
            };

            await salvarCaixa();
            
            const badge = document.getElementById('caixaStatusBadge');
            badge.className = 'badge badge-success';
            badge.innerHTML = '<i class="fas fa-lock-open"></i> Caixa Aberto';
        }

        async function fecharCaixa() {
            const horaFechamento = new Date();
            caixaAberto = false;

            faturaAtual.dataFechamento = horaFechamento.toISOString();
            faturaAtual.produtos = [...produtosVenda];
            faturaAtual.total = calcularTotal();
            
            await adicionarFaturaFirebase(faturaAtual);
            await limparVendasFirebase();
            
            caixaAberto = false;
            horaAbertura = null;
            faturaAtual = null;
            
            await salvarCaixa();
            
            const badge = document.getElementById('caixaStatusBadge');
            badge.className = 'badge badge-danger';
            badge.innerHTML = '<i class="fas fa-lock"></i> Caixa Fechado';

            alert(`Caixa fechado!\nTotal: R$ ${faturaAtual.total.toFixed(2).replace('.', ',')}`);
        }

        function updateCaixaUI(fechado = false) {
            const icon = document.getElementById('caixaIcon');
            const titulo = document.getElementById('caixaTitulo');
            const btn = document.getElementById('btnCaixa');
            const info = document.getElementById('caixaInfo');

            if (!fechado && caixaAberto) {
                icon.innerHTML = '<i class="fas fa-lock-open"></i>';
                icon.classList.add('aberto');
                titulo.textContent = 'Caixa Aberto';
                document.getElementById('horaAbertura').textContent = formatarDataHora(horaAbertura);
                document.getElementById('horaFechamento').textContent = '-';
                document.getElementById('duracao').textContent = '-';
                info.classList.add('show');
                
                btn.innerHTML = '<i class="fas fa-lock"></i> Fechar Caixa';
                btn.classList.remove('btn-abrir');
                btn.classList.add('btn-fechar');
            } else {
                icon.innerHTML = '<i class="fas fa-lock"></i>';
                icon.classList.remove('aberto');
                titulo.textContent = 'Caixa Fechado';
                info.classList.remove('show');
                
                btn.innerHTML = '<i class="fas fa-lock-open"></i> Abrir Caixa';
                btn.classList.remove('btn-fechar');
                btn.classList.add('btn-abrir');
            }
        }

        // ==================== PRODUTOS / VENDAS ====================
        window.addProduto = async function(e) {
            e.preventDefault();
            
            if (!caixaAberto) {
                alert('Abra o caixa primeiro!');
                return;
            }

            const produto = {
                id: Date.now(),
                cliente: document.getElementById('nomeCliente').value,
                nome: document.getElementById('nomeProduto').value,
                valor: parseFloat(document.getElementById('valorProduto').value),
                pagamento: document.getElementById('formaPagamento').value,
                tipo: document.getElementById('tipoEntrega').value,
                hora: new Date().toISOString()
            };

            await adicionarVendaFirebase(produto);
            document.getElementById('vendaForm').reset();
        };

        window.removerProduto = async function(id) {
            if (!confirm('Deseja remover esta venda?')) return;
            const venda = produtosVenda.find(p => p.id === id);
            if (venda && venda.firebaseId) {
                await removerVendaFirebase(venda.firebaseId);
            }
        };

        window.editarProduto = function(id) {
            const produto = produtosVenda.find(p => p.id === id);
            if (!produto) return;

            document.getElementById('editId').value = id;
            document.getElementById('editCliente').value = produto.cliente;
            document.getElementById('editProduto').value = produto.nome;
            document.getElementById('editValor').value = produto.valor;
            document.getElementById('editPagamento').value = produto.pagamento;
            document.getElementById('editTipo').value = produto.tipo;

            document.getElementById('modalEditar').classList.add('active');
        };

        window.salvarEdicao = async function(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editId').value);
            const produto = produtosVenda.find(p => p.id === id);
            
            if (produto && produto.firebaseId) {
                const novosDados = {
                    cliente: document.getElementById('editCliente').value,
                    nome: document.getElementById('editProduto').value,
                    valor: parseFloat(document.getElementById('editValor').value),
                    pagamento: document.getElementById('editPagamento').value,
                    tipo: document.getElementById('editTipo').value
                };
                
                await atualizarVendaFirebase(produto.firebaseId, novosDados);
                closeModalEditar();
            }
        };

        function atualizarTabela() {
            const tbody = document.getElementById('tabelaProdutos');
            
            if (produtosVenda.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhuma venda registrada</td></tr>';
                return;
            }

            tbody.innerHTML = produtosVenda.map(p => `
                <tr>
                    <td><strong>${p.cliente}</strong></td>
                    <td>${p.nome}</td>
                    <td>R$ ${p.valor.toFixed(2).replace('.', ',')}</td>
                    <td><span style="background: #f0f0f0; padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.8rem;">${p.pagamento}</span></td>
                    <td><span class="tag tag-${p.tipo.toLowerCase()}">${p.tipo}</span></td>
                    <td>
                        <button class="btn-action btn-edit" onclick="editarProduto(${p.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="removerProduto(${p.id})" title="Remover">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function calcularTotal() {
            return produtosVenda.reduce((s, p) => s + p.valor, 0);
        }

        function atualizarTotal() {
            document.getElementById('totalVendas').textContent = 'R$ ' + calcularTotal().toFixed(2).replace('.', ',');
        }

        window.closeModalEditar = function() {
            document.getElementById('modalEditar').classList.remove('active');
        };

        // ==================== DISPENSAS ====================
        window.addDispensa = async function(e) {
            e.preventDefault();
            
            const dispensa = {
                id: Date.now(),
                nome: document.getElementById('nomeDispensa').value,
                valor: parseFloat(document.getElementById('valorDispensa').value),
                data: new Date().toISOString()
            };

            await adicionarDispensaFirebase(dispensa);
            document.getElementById('dispensaForm').reset();
        };

        function carregarDispensas() {
            const containerCadastrados = document.getElementById('listaDispensasCadastradas');
            if (dispensas.length === 0) {
                containerCadastrados.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>Nenhum produto cadastrado</p></div>';
            } else {
                containerCadastrados.innerHTML = dispensas.map(d => `
                    <div class="dispensa-item" style="padding: 0.8rem; margin-bottom: 0.5rem;">
                        <div>
                            <strong style="color: #4a148c;">${d.nome}</strong>
                            <span style="color: #4caf50; margin-left: 0.5rem;">R$ ${d.valor.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <button class="btn-delete" onclick="removerDispensa(${d.id}, '${d.firebaseId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            const containerCompra = document.getElementById('listaDispensasCompra');
            if (dispensas.length === 0) {
                containerCompra.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>Cadastre produtos primeiro</p></div>';
            } else {
                containerCompra.innerHTML = dispensas.map(d => `
                    <div class="dispensa-item ${itensSelecionados.has(d.id) ? 'selected' : ''}" 
                         onclick="toggleItemDispensa(${d.id})">
                        <div>
                            <strong style="color: #4a148c;">${d.nome}</strong>
                            <p style="color: #666; font-size: 0.9rem;">Clique para ${itensSelecionados.has(d.id) ? 'remover' : 'adicionar'}</p>
                        </div>
                        <div class="dispensa-valor">R$ ${d.valor.toFixed(2).replace('.', ',')}</div>
                    </div>
                `).join('');
            }

            atualizarTotalDispensa();
        }

        window.removerDispensa = async function(id, firebaseId) {
            if (!confirm('Deseja remover este produto?')) return;
            itensSelecionados.delete(id);
            await removerDispensaFirebase(firebaseId);
        };

        window.toggleItemDispensa = function(id) {
            if (itensSelecionados.has(id)) {
                itensSelecionados.delete(id);
            } else {
                itensSelecionados.add(id);
            }
            carregarDispensas();
        };

        function atualizarTotalDispensa() {
            let total = 0;
            itensSelecionados.forEach(id => {
                const item = dispensas.find(d => d.id === id);
                if (item) total += item.valor;
            });
            
            document.getElementById('countItens').textContent = itensSelecionados.size;
            document.getElementById('totalDispensa').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
            document.getElementById('btnFinalizarCompra').disabled = itensSelecionados.size === 0;
        }

        window.finalizarCompraDispensa = async function() {
            if (itensSelecionados.size === 0) return;

            const itens = [];
            let total = 0;
            
            itensSelecionados.forEach(id => {
                const item = dispensas.find(d => d.id === id);
                if (item) {
                    itens.push(item);
                    total += item.valor;
                }
            });

            const compra = {
                id: Date.now(),
                data: new Date().toISOString(),
                itens: itens,
                total: total
            };

            await adicionarCompraFirebase(compra);
            itensSelecionados.clear();
            carregarDispensas();
            
            alert(`Compra registrada!\nTotal: R$ ${total.toFixed(2).replace('.', ',')}`);
        };

        function carregarHistoricoDispensas() {
            const container = document.getElementById('historicoDispensas');
            
            if (comprasDispensa.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-bag"></i>
                        <p>Nenhuma compra registrada</p>
                    </div>`;
                return;
            }

            container.innerHTML = comprasDispensa.map((c, i) => {
                const data = new Date(c.data);
                return `
                    <div class="fatura-card" onclick="verDetalhesCompra(${c.id})">
                        <div class="fatura-header">
                            <span class="fatura-numero">Compra #${comprasDispensa.length - i}</span>
                            <span class="fatura-status status-fechada">Finalizada</span>
                        </div>
                        <div class="fatura-info">
                            <span><i class="fas fa-calendar"></i> ${data.toLocaleDateString('pt-BR')}</span>
                            <span><i class="fas fa-clock"></i> ${data.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</span>
                            <span><i class="fas fa-shopping-bag"></i> ${c.itens.length} itens</span>
                        </div>
                        <div class="fatura-total">Total: R$ ${c.total.toFixed(2).replace('.', ',')}</div>
                    </div>
                `;
            }).join('');
        }

        window.verDetalhesCompra = function(id) {
            const compra = comprasDispensa.find(c => c.id === id);
            if (!compra) return;

            const data = new Date(compra.data);

            let html = `
                <div style="margin-bottom: 1rem;">
                    <p style="margin: 0.5rem 0;"><strong>Data:</strong> ${formatarDataHora(data)}</p>
                    <p style="margin: 0.5rem 0;"><strong>Itens:</strong> ${compra.itens.length}</p>
                </div>
                <h4 style="color: #4a148c; margin: 1rem 0;">Produtos:</h4>
                <div style="background: #f8f9fa; border-radius: 12px; padding: 1rem;">
            `;

            html += compra.itens.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                    <span>${item.nome}</span>
                    <strong>R$ ${item.valor.toFixed(2).replace('.', ',')}</strong>
                </div>
            `).join('');

            html += `
                </div>
                <div style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; padding: 1rem; border-radius: 12px; margin-top: 1rem; display: flex; justify-content: space-between;">
                    <span>TOTAL</span>
                    <strong style="font-size: 1.3rem;">R$ ${compra.total.toFixed(2).replace('.', ',')}</strong>
                </div>
            `;

            document.getElementById('modalCompraBody').innerHTML = html;
            document.getElementById('modalCompra').classList.add('active');
        };

        window.closeModalCompra = function() {
            document.getElementById('modalCompra').classList.remove('active');
        };

        // ==================== FATURAS ====================
        function carregarFaturas() {
            const container = document.getElementById('listaFaturas');
            
            if (faturas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>Nenhuma fatura registrada</p>
                    </div>`;
                return;
            }

            container.innerHTML = faturas.map((f, i) => {
                const abertura = new Date(f.dataAbertura);
                const fechamento = f.dataFechamento ? new Date(f.dataFechamento) : null;
                
                return `
                    <div class="fatura-card" onclick="verFatura(${f.id})">
                        <div class="fatura-header">
                            <span class="fatura-numero">Fatura #${faturas.length - i}</span>
                            <span class="fatura-status ${fechamento ? 'status-fechada' : 'status-aberta'}">
                                ${fechamento ? 'Fechada' : 'Em Aberto'}
                            </span>
                        </div>
                        <div class="fatura-info">
                            <span><i class="fas fa-calendar"></i> ${abertura.toLocaleDateString('pt-BR')}</span>
                            <span><i class="fas fa-clock"></i> ${abertura.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</span>
                            <span><i class="fas fa-shopping-bag"></i> ${f.produtos ? f.produtos.length : 0} vendas</span>
                        </div>
                        <div class="fatura-total">Total: R$ ${f.total ? f.total.toFixed(2).replace('.', ',') : '0,00'}</div>
                    </div>
                `;
            }).join('');
        }

        window.verFatura = function(id) {
            const f = faturas.find(x => x.id === id);
            if (!f) return;

            const abertura = new Date(f.dataAbertura);
            const fechamento = f.dataFechamento ? new Date(f.dataFechamento) : null;

            let html = `
                <div style="margin-bottom: 1rem;">
                    <p style="margin: 0.5rem 0;"><strong>Aberto:</strong> ${formatarDataHora(abertura)}</p>
                    ${fechamento ? `<p style="margin: 0.5rem 0;"><strong>Fechado:</strong> ${formatarDataHora(fechamento)}</p>` : '<p style="color: #4caf50;"><i class="fas fa-circle"></i> Caixa em aberto</p>'}
                </div>
                <h4 style="color: #4a148c; margin: 1rem 0;">Vendas:</h4>
                <div style="background: #f8f9fa; border-radius: 12px; padding: 1rem;">
            `;

            if (!f.produtos || f.produtos.length === 0) {
                html += '<p style="color: #999; text-align: center;">Nenhuma venda</p>';
            } else {
                html += f.produtos.map(p => `
                    <div style="padding: 0.8rem 0; border-bottom: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <strong>${p.cliente}</strong>
                            <span style="font-weight: 600; color: #4a148c;">R$ ${p.valor.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #666; flex-wrap: wrap;">
                            <span><i class="fas fa-ice-cream"></i> ${p.nome}</span>
                            <span><i class="fas fa-credit-card"></i> ${p.pagamento}</span>
                            <span class="tag tag-${p.tipo.toLowerCase()}" style="font-size: 0.7rem;">${p.tipo}</span>
                        </div>
                    </div>
                `).join('');
            }

            html += `
                </div>
                <div style="background: linear-gradient(135deg, #4a148c 0%, #7c43bd 100%); color: white; padding: 1rem; border-radius: 12px; margin-top: 1rem; display: flex; justify-content: space-between;">
                    <span>TOTAL GERAL</span>
                    <strong style="font-size: 1.3rem;">R$ ${f.total ? f.total.toFixed(2).replace('.', ',') : '0,00'}</strong>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalFatura').classList.add('active');
        };

        window.closeModalFatura = function() {
            document.getElementById('modalFatura').classList.remove('active');
        };

        // ==================== UTILITÁRIOS ====================
        function formatarDataHora(date) {
            return date.toLocaleString('pt-BR');
        }

        window.switchTab = function(tabName, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        };

        window.logout = async function() {
            if (caixaAberto && !confirm('O caixa está aberto! Deseja fechar e sair?')) return;
            if (caixaAberto) await fecharCaixa();
            
            localStorage.removeItem('acaiRei_session');
            location.reload();
        };

        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const input = document.getElementById('password');
            input.type = input.type === 'password' ? 'text' : 'password';
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Tornar funções globais para os event handlers inline
        Object.assign(window, {
            db, caixaAberto, horaAbertura, produtosVenda, faturas, 
            faturaAtual, currentUser, dispensas, comprasDispensa, itensSelecionados
        });
    </script>
</body>
</html>
